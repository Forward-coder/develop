import{_ as ie,m as q,I as pe,B as me,r as i,o as b,c as C,b as l,w as t,e as y,f as h,E as N,a as u,i as f,t as w,F,C as B,n as k,g as R,J as fe,L as ve,D as be,A as ye,M as _e}from"./index-31da5b45.js";import{g as ge,a as ce,s as Ve,d as Ne}from"./member-81fbc822.js";import{d as ke}from"./dict-89fa1e0a.js";import"./request-3269837c.js";const xe={class:"page"},we={class:"stats-bar",style:{"margin-bottom":"15px",padding:"10px",background:"#f0f9ff","border-radius":"4px"}},Ie={class:"stat-item"},Me={class:"stat-value"},Ae={class:"stat-item"},De={class:"stat-value",style:{color:"#67c23a"}},Ue={class:"stat-item"},Te={class:"stat-value"},Ce={class:"stat-item"},Le={class:"stat-value",style:{color:"#409eff"}},Pe={class:"toolbar"},Se={style:{"margin-top":"10px"}},$e={style:{"margin-top":"10px",padding:"10px",background:"#f5f7fa","border-radius":"4px"}},he={__name:"MemberList",setup(Fe){const _=y([]),I=y([]),M=y([]),r=h({memberNo:"",name:"",phone:"",idNo:"",levelId:null,status:"",minPoints:null,maxPoints:null,startDate:"",endDate:""}),x=y(!1),T=y([]),A=y(!1),z=y(!1),J=y({}),L=y(null),P=y(!1),g=y(""),n=h({id:null,memberNo:"",name:"",phone:"",idTypeId:null,idTypeName:"",idNo:"",levelId:null,levelName:"",points:0,status:1,remark:""}),S=h({type:"add",points:0,remark:""}),Q={name:[{required:!0,message:"请输入姓名",trigger:"blur"}]},W=q(()=>{if(!Array.isArray(_.value)||_.value.length===0)return 0;const o=_.value.reduce((e,s)=>e+(s.points||0),0);return Math.round(o/_.value.length)}),G=q(()=>{if(!Array.isArray(_.value))return 0;const o=new Date().toISOString().split("T")[0];return _.value.filter(e=>e.createdAt&&e.createdAt.startsWith(o)).length});async function D(){var o;try{const e=await ge(r);console.log("Member API Response:",e);const s=((o=e==null?void 0:e.data)==null?void 0:o.data)||(e==null?void 0:e.data)||e||[];_.value=s.map(d=>{var c,p;return{...d,idTypeName:Array.isArray(I.value)&&((c=I.value.find(m=>m.id===d.idTypeId))==null?void 0:c.name)||d.idTypeName,levelName:Array.isArray(M.value)&&((p=M.value.find(m=>m.id===d.levelId))==null?void 0:p.name)||d.levelName}})}catch(e){console.error("Load member list error:",e),N.error("加载会员数据失败")}}async function H(){try{const[o,e]=await Promise.all([ke(),ce()]);I.value=Array.isArray(o==null?void 0:o.data)?o.data:Array.isArray(o)?o:[],M.value=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e)?e:[]}catch(o){console.error("Load dict error:",o),N.error("加载字典数据失败")}}function E(o){o?(Object.assign(n,{id:o.id,memberNo:o.memberNo,name:o.name,phone:o.phone,idTypeId:o.idTypeId,idTypeName:o.idTypeName,idNo:o.idNo,levelId:o.levelId,levelName:o.levelName,points:o.points??0,status:o.status??1,remark:o.remark}),g.value=""):(Y(),j()),A.value=!0}function Y(){var o;Object.assign(n,{id:null,memberNo:"",name:"",phone:"",idTypeId:null,idTypeName:"",idNo:"",levelId:null,levelName:"",points:0,status:1,remark:""}),g.value="",(o=L.value)==null||o.resetFields()}async function j(){try{const o=new Date,e=o.getFullYear(),s=String(o.getMonth()+1).padStart(2,"0"),d=String(o.getDate()).padStart(2,"0"),c=`${e}${s}${d}`,p=Math.floor(Math.random()*1e6);g.value=`M${c}${String(p).padStart(6,"0")}`}catch(o){console.error("生成预览卡号失败:",o),g.value="生成失败"}}function K(){j(),N.info("会员卡号已刷新")}function X(){Object.assign(r,{memberNo:"",name:"",phone:"",idNo:"",levelId:null,status:"",minPoints:null,maxPoints:null,startDate:"",endDate:""}),T.value=[],x.value=!1,D()}function Z(){N.info("导出功能开发中...")}pe(T,o=>{o&&o.length===2?(r.startDate=o[0],r.endDate=o[1]):(r.startDate="",r.endDate="")});async function ee(){var e;await((e=L.value)==null?void 0:e.validate().catch(()=>{}));const o=I.value.find(s=>s.id===n.idTypeId);P.value=!0;try{const s={...n,idTypeName:o==null?void 0:o.name};!n.id&&!n.memberNo&&g.value&&(s.memberNo=g.value),await Ve(s),N.success("保存成功"),A.value=!1,D()}catch(s){N.error((s==null?void 0:s.message)||"保存失败")}finally{P.value=!1}}async function le(o){await be.confirm("确定删除该会员档案吗？","提示",{type:"warning"}),await Ne(o.id),N.success("删除成功"),D()}function ae(o){J.value=o,S.type="add",S.points=0,S.remark="",z.value=!0}return me(async()=>{await H(),await D()}),(o,e)=>{const s=i("el-button"),d=i("el-col"),c=i("el-row"),p=i("el-input"),m=i("el-option"),U=i("el-select"),te=i("el-icon"),$=i("el-input-number"),v=i("el-form-item"),oe=i("el-date-picker"),V=i("el-table-column"),ne=i("el-tag"),de=i("el-table"),se=i("el-card"),re=i("el-form"),ue=i("el-dialog");return b(),C("div",xe,[l(se,null,{header:t(()=>[e[24]||(e[24]=u("span",null,"会员档案",-1)),l(s,{type:"primary",style:{float:"right"},onClick:e[0]||(e[0]=a=>E())},{default:t(()=>[...e[23]||(e[23]=[f("新增会员",-1)])]),_:1})]),default:t(()=>[u("div",we,[l(c,{gutter:20},{default:t(()=>[l(d,{span:6},{default:t(()=>[u("div",Ie,[e[25]||(e[25]=u("span",{class:"stat-label"},"总会员数:",-1)),u("span",Me,w(_.value.length),1)])]),_:1}),l(d,{span:6},{default:t(()=>[u("div",Ae,[e[26]||(e[26]=u("span",{class:"stat-label"},"正常会员:",-1)),u("span",De,w(_.value.filter(a=>a.status===1).length),1)])]),_:1}),l(d,{span:6},{default:t(()=>[u("div",Ue,[e[27]||(e[27]=u("span",{class:"stat-label"},"平均积分:",-1)),u("span",Te,w(W.value),1)])]),_:1}),l(d,{span:6},{default:t(()=>[u("div",Ce,[e[28]||(e[28]=u("span",{class:"stat-label"},"今日新增:",-1)),u("span",Le,w(G.value),1)])]),_:1})]),_:1})]),u("div",Pe,[l(c,{gutter:10},{default:t(()=>[l(d,{span:4},{default:t(()=>[l(p,{modelValue:r.memberNo,"onUpdate:modelValue":e[1]||(e[1]=a=>r.memberNo=a),placeholder:"会员卡号",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{span:3},{default:t(()=>[l(p,{modelValue:r.name,"onUpdate:modelValue":e[2]||(e[2]=a=>r.name=a),placeholder:"姓名",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{span:4},{default:t(()=>[l(p,{modelValue:r.phone,"onUpdate:modelValue":e[3]||(e[3]=a=>r.phone=a),placeholder:"手机号",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{span:4},{default:t(()=>[l(p,{modelValue:r.idNo,"onUpdate:modelValue":e[4]||(e[4]=a=>r.idNo=a),placeholder:"证件号",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{span:3},{default:t(()=>[l(U,{modelValue:r.levelId,"onUpdate:modelValue":e[5]||(e[5]=a=>r.levelId=a),placeholder:"会员等级",clearable:""},{default:t(()=>[(b(!0),C(F,null,B(M.value,a=>(b(),k(m,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(d,{span:3},{default:t(()=>[l(U,{modelValue:r.status,"onUpdate:modelValue":e[6]||(e[6]=a=>r.status=a),placeholder:"状态",clearable:""},{default:t(()=>[l(m,{label:"正常",value:1}),l(m,{label:"冻结",value:2}),l(m,{label:"黑名单",value:3})]),_:1},8,["modelValue"])]),_:1}),l(d,{span:3},{default:t(()=>[l(s,{type:"primary",onClick:D},{default:t(()=>[...e[29]||(e[29]=[f("查询",-1)])]),_:1}),l(s,{onClick:X},{default:t(()=>[...e[30]||(e[30]=[f("重置",-1)])]),_:1})]),_:1})]),_:1}),u("div",Se,[l(s,{link:"",type:"primary",onClick:e[7]||(e[7]=a=>x.value=!x.value)},{default:t(()=>[f(w(x.value?"收起高级筛选":"展开高级筛选")+" ",1),l(te,null,{default:t(()=>[x.value?(b(),k(R(_e),{key:1})):(b(),k(R(ye),{key:0}))]),_:1})]),_:1})]),fe(u("div",$e,[l(c,{gutter:10},{default:t(()=>[l(d,{span:6},{default:t(()=>[l(v,{label:"积分范围","label-width":"80px"},{default:t(()=>[l(d,{span:11},{default:t(()=>[l($,{modelValue:r.minPoints,"onUpdate:modelValue":e[8]||(e[8]=a=>r.minPoints=a),min:0,placeholder:"最小积分",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(d,{span:2,style:{"text-align":"center"}},{default:t(()=>[...e[31]||(e[31]=[f("-",-1)])]),_:1}),l(d,{span:11},{default:t(()=>[l($,{modelValue:r.maxPoints,"onUpdate:modelValue":e[9]||(e[9]=a=>r.maxPoints=a),min:0,placeholder:"最大积分",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(d,{span:8},{default:t(()=>[l(v,{label:"注册时间","label-width":"80px"},{default:t(()=>[l(oe,{modelValue:T.value,"onUpdate:modelValue":e[10]||(e[10]=a=>T.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(d,{span:4},{default:t(()=>[l(s,{type:"success",onClick:Z},{default:t(()=>[...e[32]||(e[32]=[f("导出Excel",-1)])]),_:1})]),_:1})]),_:1})],512),[[ve,x.value]])]),l(de,{data:_.value,border:"",stripe:""},{default:t(()=>[l(V,{prop:"memberNo",label:"会员卡号",width:"120"}),l(V,{prop:"name",label:"姓名",width:"100"}),l(V,{prop:"phone",label:"手机号",width:"130"}),l(V,{prop:"levelName",label:"会员等级",width:"100"}),l(V,{prop:"points",label:"积分",width:"90",sortable:""}),l(V,{prop:"statusName",label:"状态",width:"90"},{default:t(({row:a})=>[l(ne,{type:a.status===1?"success":a.status===2?"warning":"danger"},{default:t(()=>[f(w(a.statusName),1)]),_:2},1032,["type"])]),_:1}),l(V,{prop:"createdAt",label:"注册时间",width:"160"}),l(V,{label:"操作",width:"180",fixed:"right"},{default:t(({row:a})=>[l(s,{link:"",type:"primary",onClick:O=>E(a)},{default:t(()=>[...e[33]||(e[33]=[f("编辑",-1)])]),_:1},8,["onClick"]),l(s,{link:"",type:"success",onClick:O=>ae(a)},{default:t(()=>[...e[34]||(e[34]=[f("调积分",-1)])]),_:1},8,["onClick"]),l(s,{link:"",type:"danger",onClick:O=>le(a)},{default:t(()=>[...e[35]||(e[35]=[f("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),l(ue,{modelValue:A.value,"onUpdate:modelValue":e[22]||(e[22]=a=>A.value=a),title:n.id?"编辑会员":"新增会员",width:"500px",onClose:Y},{footer:t(()=>[l(s,{onClick:e[21]||(e[21]=a=>A.value=!1)},{default:t(()=>[...e[38]||(e[38]=[f("取消",-1)])]),_:1}),l(s,{type:"primary",loading:P.value,onClick:ee},{default:t(()=>[...e[39]||(e[39]=[f("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(re,{ref_key:"formRef",ref:L,model:n,rules:Q,"label-width":"90px"},{default:t(()=>[n.id?(b(),k(v,{key:0,label:"会员卡号"},{default:t(()=>[l(p,{modelValue:n.memberNo,"onUpdate:modelValue":e[11]||(e[11]=a=>n.memberNo=a),disabled:""},null,8,["modelValue"])]),_:1})):(b(),k(v,{key:1,label:"会员卡号"},{default:t(()=>[l(p,{modelValue:g.value,"onUpdate:modelValue":e[12]||(e[12]=a=>g.value=a),disabled:"",placeholder:"系统自动生成"},{append:t(()=>[l(s,{onClick:K},{default:t(()=>[...e[36]||(e[36]=[f("刷新",-1)])]),_:1})]),_:1},8,["modelValue"]),e[37]||(e[37]=u("div",{style:{"font-size":"12px",color:"#999","margin-top":"5px"}}," 系统将自动生成唯一会员卡号 ",-1))]),_:1})),l(v,{label:"姓名",prop:"name"},{default:t(()=>[l(p,{modelValue:n.name,"onUpdate:modelValue":e[13]||(e[13]=a=>n.name=a),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),l(v,{label:"手机号",prop:"phone"},{default:t(()=>[l(p,{modelValue:n.phone,"onUpdate:modelValue":e[14]||(e[14]=a=>n.phone=a),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),l(v,{label:"证件类型",prop:"idTypeId"},{default:t(()=>[l(U,{modelValue:n.idTypeId,"onUpdate:modelValue":e[15]||(e[15]=a=>n.idTypeId=a),placeholder:"请选择",style:{width:"100%"}},{default:t(()=>[(b(!0),C(F,null,B(I.value,a=>(b(),k(m,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(v,{label:"证件号",prop:"idNo"},{default:t(()=>[l(p,{modelValue:n.idNo,"onUpdate:modelValue":e[16]||(e[16]=a=>n.idNo=a),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),l(v,{label:"会员等级",prop:"levelId"},{default:t(()=>[l(U,{modelValue:n.levelId,"onUpdate:modelValue":e[17]||(e[17]=a=>n.levelId=a),placeholder:"请选择",style:{width:"100%"}},{default:t(()=>[(b(!0),C(F,null,B(M.value,a=>(b(),k(m,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(v,{label:"积分",prop:"points"},{default:t(()=>[l($,{modelValue:n.points,"onUpdate:modelValue":e[18]||(e[18]=a=>n.points=a),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(v,{label:"状态",prop:"status"},{default:t(()=>[l(U,{modelValue:n.status,"onUpdate:modelValue":e[19]||(e[19]=a=>n.status=a),placeholder:"请选择",style:{width:"100%"}},{default:t(()=>[l(m,{label:"正常",value:1}),l(m,{label:"冻结",value:2}),l(m,{label:"黑名单",value:3})]),_:1},8,["modelValue"])]),_:1}),l(v,{label:"备注",prop:"remark"},{default:t(()=>[l(p,{modelValue:n.remark,"onUpdate:modelValue":e[20]||(e[20]=a=>n.remark=a),type:"textarea",rows:"2"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Oe=ie(he,[["__scopeId","data-v-54e79a36"]]);export{Oe as default};
