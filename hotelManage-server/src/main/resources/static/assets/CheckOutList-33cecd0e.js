import{r as L}from"./request-7f0efd49.js";import{_ as K,m as Q,B as W,r,o as x,c as N,b as l,w as t,e as _,E as v,a as C,i as s,t as g,G as H,n as X,f as Y}from"./index-fddec7dd.js";function Z(){return L({url:"/api/checkout/pending",method:"get"})}function ee(h){return L({url:`/api/checkout/${h}/preview`,method:"get"})}function le(h){return L({url:"/api/checkout/checkout",method:"post",data:h})}const te={class:"page"},ae={class:"toolbar"},oe={key:0},ne={key:0,class:"bill-section"},ue={__name:"CheckOutList",setup(h){const b=_([]),k=_(!1),d=_(null),i=_(null),P=_(null),I=_(!1),u=Y({checkInId:null,depositHandling:"refund",actualPaid:0,remark:""}),F={depositHandling:[{required:!0,message:"请选择押金处理方式",trigger:"change"}],actualPaid:[{required:!0,message:"请输入实际收款金额",trigger:"blur"}]},V=Q(()=>{if(!i.value||u.actualPaid===null)return null;let a=0;return u.depositHandling==="refund"?a=u.actualPaid-i.value.totalAmount+i.value.depositTotal:a=u.actualPaid-i.value.totalAmount,parseFloat(a.toFixed(2))});async function A(){var a;try{console.log("=== 刷新操作开始 ===");const e=await Z();console.log("API响应:",e),Array.isArray(e==null?void 0:e.data)?b.value=e.data:Array.isArray((a=e==null?void 0:e.data)==null?void 0:a.data)?b.value=e.data.data:Array.isArray(e)?b.value=e:b.value=[],v.success("数据已刷新"),console.log("=== 刷新操作完成 ===")}catch(e){console.error("刷新失败:",e),v.error("刷新失败，请检查网络连接")}}function R(){console.log("刷新按钮被点击了！"),A()}function q(a){d.value=a,u.checkInId=a.id,D(a.id),k.value=!0}async function D(a){var e;try{const o=await ee(a),n=((e=o==null?void 0:o.data)==null?void 0:e.bill)||(o==null?void 0:o.bill)||(o==null?void 0:o.data);i.value=n,u.actualPaid=(n==null?void 0:n.totalAmount)||0}catch(o){console.error("加载账单预览失败:",o),v.error("加载账单预览失败")}}function O(){var a;d.value=null,i.value=null,u.checkInId=null,u.depositHandling="refund",u.actualPaid=0,u.remark="",(a=P.value)==null||a.resetFields()}async function U(){var a,e;await((a=P.value)==null?void 0:a.validate().catch(()=>{})),I.value=!0;try{const o={checkInId:u.checkInId,depositHandling:u.depositHandling,actualPaid:u.actualPaid,remark:u.remark},n=await le(o),c=((e=n==null?void 0:n.data)==null?void 0:e.result)||(n==null?void 0:n.result)||n;c!=null&&c.success?(v.success("退房结账成功"),k.value=!1,A()):v.error((c==null?void 0:c.message)||"退房结账失败")}catch(o){console.error("退房结账失败:",o),v.error((o==null?void 0:o.message)||"退房结账失败")}finally{I.value=!1}}function E(a){return a?new Date(a).toLocaleString("zh-CN"):""}return W(()=>{A()}),(a,e)=>{const o=r("el-button"),n=r("el-table-column"),c=r("el-table"),G=r("el-card"),m=r("el-descriptions-item"),M=r("el-descriptions"),f=r("el-statistic"),y=r("el-col"),T=r("el-row"),B=r("el-radio"),$=r("el-radio-group"),w=r("el-form-item"),z=r("el-input-number"),S=r("el-input"),j=r("el-form"),J=r("el-dialog");return x(),N("div",te,[l(G,null,{header:t(()=>[...e[5]||(e[5]=[C("span",null,"退房结账",-1)])]),default:t(()=>[C("div",ae,[l(o,{type:"primary",onClick:R},{default:t(()=>[...e[6]||(e[6]=[s("刷新列表",-1)])]),_:1})]),l(c,{data:b.value,border:"",stripe:"",onRowClick:q},{default:t(()=>[l(n,{prop:"checkInNo",label:"入住单号",width:"160"}),l(n,{prop:"roomNo",label:"房号",width:"80"}),l(n,{prop:"roomTypeName",label:"房型",width:"90"}),l(n,{prop:"guestName",label:"客人",width:"90"}),l(n,{prop:"guestPhone",label:"电话",width:"120"}),l(n,{prop:"actualCheckInTime",label:"入住时间",width:"160"}),l(n,{prop:"plannedCheckOutDate",label:"预计退房",width:"110"}),l(n,{prop:"roomRate",label:"房价",width:"80"}),l(n,{prop:"depositTotal",label:"押金",width:"80"})]),_:1},8,["data"])]),_:1}),l(J,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=p=>k.value=p),title:"退房结账",width:"700px",onClose:O},{footer:t(()=>[l(o,{onClick:e[3]||(e[3]=p=>k.value=!1)},{default:t(()=>[...e[11]||(e[11]=[s("取消",-1)])]),_:1}),l(o,{type:"primary",loading:I.value,onClick:U},{default:t(()=>[...e[12]||(e[12]=[s("确认退房",-1)])]),_:1},8,["loading"])]),default:t(()=>[d.value?(x(),N("div",oe,[l(M,{column:3,border:""},{default:t(()=>[l(m,{label:"入住单号"},{default:t(()=>[s(g(d.value.checkInNo),1)]),_:1}),l(m,{label:"房号"},{default:t(()=>[s(g(d.value.roomNo),1)]),_:1}),l(m,{label:"房型"},{default:t(()=>[s(g(d.value.roomTypeName),1)]),_:1}),l(m,{label:"客人姓名"},{default:t(()=>[s(g(d.value.guestName),1)]),_:1}),l(m,{label:"联系电话"},{default:t(()=>[s(g(d.value.guestPhone),1)]),_:1}),l(m,{label:"入住时间"},{default:t(()=>[s(g(E(d.value.actualCheckInTime)),1)]),_:1})]),_:1}),i.value?(x(),N("div",ne,[e[7]||(e[7]=C("h3",null,"账单信息",-1)),l(T,{gutter:20},{default:t(()=>[l(y,{span:8},{default:t(()=>[l(f,{title:"房费",value:i.value.roomFee,prefix:"¥"},null,8,["value"])]),_:1}),l(y,{span:8},{default:t(()=>[l(f,{title:"消费费用",value:i.value.consumptionFee,prefix:"¥"},null,8,["value"])]),_:1}),l(y,{span:8},{default:t(()=>[l(f,{title:"总金额",value:i.value.totalAmount,prefix:"¥"},null,8,["value"])]),_:1})]),_:1}),l(T,{gutter:20,style:{"margin-top":"20px"}},{default:t(()=>[l(y,{span:8},{default:t(()=>[l(f,{title:"押金",value:i.value.depositTotal,prefix:"¥"},null,8,["value"])]),_:1}),l(y,{span:8},{default:t(()=>[l(f,{title:"应收金额",value:i.value.totalAmount,prefix:"¥"},null,8,["value"])]),_:1})]),_:1})])):H("",!0),l(j,{ref_key:"formRef",ref:P,model:u,rules:F,"label-width":"100px",style:{"margin-top":"20px"}},{default:t(()=>[l(w,{label:"押金处理",prop:"depositHandling"},{default:t(()=>[l($,{modelValue:u.depositHandling,"onUpdate:modelValue":e[0]||(e[0]=p=>u.depositHandling=p)},{default:t(()=>[l(B,{label:"refund"},{default:t(()=>[...e[8]||(e[8]=[s("退还押金",-1)])]),_:1}),l(B,{label:"excess"},{default:t(()=>[...e[9]||(e[9]=[s("补缴差额",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(w,{label:"实际收款",prop:"actualPaid"},{default:t(()=>[l(z,{modelValue:u.actualPaid,"onUpdate:modelValue":e[1]||(e[1]=p=>u.actualPaid=p),min:0,precision:2,style:{width:"200px"}},null,8,["modelValue"]),e[10]||(e[10]=C("span",{style:{"margin-left":"10px"}},"元",-1))]),_:1}),V.value!==null?(x(),X(w,{key:0,label:"找零"},{default:t(()=>[l(f,{value:V.value,prefix:"¥","value-style":{color:V.value>=0?"#67c23a":"#f56c6c"}},null,8,["value","value-style"])]),_:1})):H("",!0),l(w,{label:"备注",prop:"remark"},{default:t(()=>[l(S,{modelValue:u.remark,"onUpdate:modelValue":e[2]||(e[2]=p=>u.remark=p),type:"textarea",rows:"2"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):H("",!0)]),_:1},8,["modelValue"])])}}},se=K(ue,[["__scopeId","data-v-a62e71fd"]]);export{se as default};
