<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hotel.manage.mapper.CheckInMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.hotel.manage.entity.CheckIn">
        <id column="id" property="id"/>
        <result column="hotel_id" property="hotelId"/>
        <result column="check_in_no" property="checkInNo"/>
        <result column="reservation_id" property="reservationId"/>
        <result column="room_id" property="roomId"/>
        <result column="room_type_id" property="roomTypeId"/>
        <result column="actual_check_in_time" property="actualCheckInTime"/>
        <result column="planned_check_out_date" property="plannedCheckOutDate"/>
        <result column="actual_check_out_time" property="actualCheckOutTime"/>
        <result column="room_rate" property="roomRate"/>
        <result column="guest_name" property="guestName"/>
        <result column="guest_phone" property="guestPhone"/>
        <result column="guest_id_type_id" property="guestIdTypeId"/>
        <result column="guest_id_no" property="guestIdNo"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <!-- 关联字段 -->
        <result column="room_no" property="roomNo"/>
        <result column="room_type_name" property="roomTypeName"/>
    </resultMap>

    <!-- 查询字段 -->
    <sql id="Base_Column_List">
        ci.id, ci.hotel_id, ci.check_in_no, ci.reservation_id, ci.room_id, ci.room_type_id,
        ci.actual_check_in_time, ci.planned_check_out_date, ci.actual_check_out_time,
        ci.room_rate, ci.guest_name, ci.guest_phone, ci.guest_id_type_id, ci.guest_id_no,
        ci.deposit_total, ci.remark, ci.status, ci.created_at, ci.updated_at,
        r.room_no, rt.name as room_type_name
    </sql>

    <!-- 获取入住列表 -->
    <select id="getList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM check_in ci
        LEFT JOIN room r ON ci.room_id = r.id
        LEFT JOIN room_type rt ON ci.room_type_id = rt.id
        WHERE 1=1
        <if test="status != null and status != ''">
            AND ci.status = #{status}
        </if>
        <if test="roomNo != null and roomNo != ''">
            AND r.room_no LIKE CONCAT('%', #{roomNo}, '%')
        </if>
        <if test="guestName != null and guestName != ''">
            AND ci.guest_name LIKE CONCAT('%', #{guestName}, '%')
        </if>
        ORDER BY ci.actual_check_in_time DESC
    </select>

    <!-- 根据ID获取入住信息 -->
    <select id="getById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM check_in ci
        LEFT JOIN room r ON ci.room_id = r.id
        LEFT JOIN room_type rt ON ci.room_type_id = rt.id
        WHERE ci.id = #{id}
    </select>

    <!-- 插入入住记录 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO check_in (
            hotel_id, check_in_no, reservation_id, room_id, room_type_id,
            actual_check_in_time, planned_check_out_date, room_rate,
            guest_name, guest_phone, guest_id_type_id, guest_id_no, 
            deposit_total, remark, status
        ) VALUES (
            #{hotelId}, #{checkInNo}, #{reservationId}, #{roomId}, #{roomTypeId},
            #{actualCheckInTime}, #{plannedCheckOutDate}, #{roomRate},
            #{guestName}, #{guestPhone}, #{guestIdTypeId}, #{guestIdNo},
            #{depositTotal}, #{remark}, #{status}
        )
    </insert>

    <!-- 更新入住记录 -->
    <update id="update">
        UPDATE check_in
        <set>
            <if test="reservationId != null">reservation_id = #{reservationId},</if>
            <if test="roomId != null">room_id = #{roomId},</if>
            <if test="roomTypeId != null">room_type_id = #{roomTypeId},</if>
            <if test="actualCheckInTime != null">actual_check_in_time = #{actualCheckInTime},</if>
            <if test="plannedCheckOutDate != null">planned_check_out_date = #{plannedCheckOutDate},</if>
            <if test="actualCheckOutTime != null">actual_check_out_time = #{actualCheckOutTime},</if>
            <if test="roomRate != null">room_rate = #{roomRate},</if>
            <if test="guestName != null and guestName != ''">guest_name = #{guestName},</if>
            <if test="guestPhone != null and guestPhone != ''">guest_phone = #{guestPhone},</if>
            <if test="guestIdTypeId != null">guest_id_type_id = #{guestIdTypeId},</if>
            <if test="guestIdNo != null and guestIdNo != ''">guest_id_no = #{guestIdNo},</if>
            <if test="depositTotal != null">deposit_total = #{depositTotal},</if>
            <if test="remark != null and remark != ''">remark = #{remark},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- 获取今日最大ID用于生成单号 -->
    <select id="getMaxIdToday" resultType="java.lang.Long">
        SELECT MAX(id)
        FROM check_in
        WHERE DATE(created_at) = CURDATE()
    </select>

    <!-- 更新房间状态 -->
    <update id="updateRoomStatus">
        UPDATE room
        SET room_status_id = #{statusId}
        WHERE id = #{roomId}
    </update>

</mapper>